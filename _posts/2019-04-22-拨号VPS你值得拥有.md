---
layout:     post
title:      æ‹¨å·VPSä½ å€¼å¾—æ‹¥æœ‰
subtitle:   æ‹¨å·VPSå…·ä½“å¹²å•¥ç”¨çš„è¯·è‡ªè¡Œ Google
date:       2019-04-22
author:     Snake
header-img: https://ws2.sinaimg.cn/large/006tNc79ly1g2bodtc65mj31hc0kk7f8.jpg
catalog:    true
tags:
    - VPS
    - ä»£ç†
    - äº‘ç«‹æ–¹
    - Linux
    - squid
    - python
---



# ä¸ºå•¥æ‹¨å· VPS ä½ å€¼å¾—æ‹¥æœ‰ï¼Ÿ

è¯è¯´ IP è¿™ä¸ªä¸œè¥¿å¯¹äºç”¨ python ææä¸œè¥¿çš„äººæ¥è¯´éƒ½æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼ˆä½ æ‡‚å¾—ğŸ¤”ï¼‰ï¼Œå°è¯•è¿‡å¤šç§ IP æ–¹æ¡ˆéƒ½è§‰å¾—ä¸æ˜¯å¾ˆå¥½ç”¨ã€‚

* å…è´¹ä»£ç†ï¼šæåº¦ä¸ç¨³å®šï¼›
* æ”¶è´¹ä»£ç†ï¼šé€Ÿåº¦éå¸¸æ…¢ï¼›
* æœ¬åœ°æ‹¨å·ï¼šåˆ‡æ¢æ—¶é—´é•¿ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œåœ¨è¯•ç”¨äº†æ‹¨å· VPS ä¹‹åä»¥ä¸Šçƒ¦æ¼å…¨éƒ¨æ²¡æœ‰äº†ğŸ˜

# ä½¿ç”¨æ‹¨å· VPS åçš„æ¶æ„å˜åŒ–

ä¼ ç»Ÿçš„ python çˆ¬çˆ¬æ¶æ„éƒ½æ˜¯

> åº”ç”¨ç¨‹åº -> ä»£ç†æœåŠ¡å™¨ -> ç›®æ ‡åœ°å€

ä½¿ç”¨æ‹¨å· VPS åçš„çˆ¬çˆ¬æ¶æ„å˜ä¸º

> åº”ç”¨ç¨‹åº -> åå‘ä»£ç†æœåŠ¡å™¨ -> æ‹¨å·VPSä»£ç†æœåŠ¡å™¨ -> ç›®æ ‡åœ°å€

è¿™ç§æ¶æ„çš„æœ€å¤§å¥½å¤„å°±æ˜¯ä¼˜é›…ï¼Œä¸€åˆ‡éƒ½æ˜¯è‡ªåŠ¨åŒ–çš„ï¼Œè€Œä¸”å¯ä»¥æ ¹æ®éœ€æ±‚éšæ—¶è°ƒæ•´ã€‚

# è¿™ç¯‡æ–‡ç« è®°å½•ç‚¹ä»€ä¹ˆå‘¢ï¼Ÿ

è¦å®Œæˆä¸Šè¿°çš„æ¶æ„éœ€è¦çš„ä¸æ­¢æ˜¯ä¸€ä¸ªç¯èŠ‚çš„é…ç½®ï¼Œè€Œæœ¬æ–‡åªè®°å½•æ‹¨å· VPS æœåŠ¡å™¨å¦‚ä½•æ­å»ºï¼Œå…¶å®ƒç¯èŠ‚çš„é…ç½®æœ‰ç©ºçš„æ—¶å€™å¦æ–‡è®°å½•ã€‚

# å¼€å§‹å§......

ä½¿ç”¨è¿‡çš„å„ç§ä»£ç†åŒ…æ‹¬è¥¿åˆºä»£ç†ã€ç«™å¤§çˆ·ã€æ— æç½‘ç»œã€äº‘ç«‹æ–¹ç­‰ç­‰ï¼Œæœ€åç”¨çš„æ˜¯äº‘ç«‹æ–¹çš„æ‹¨å· VPS æœåŠ¡å™¨ï¼ŒåŸå› å¤§æ¦‚å°±æ˜¯ç•Œé¢è¿˜ä¸é”™ã€å®¢æœæŒºå¥½çš„ã€ç¨³å®šæ€§æ²¡è®°é”™çš„è¯æŒºå¥½ã€‚

## æ³¨å†Œè´¦å·

æ³¨å†Œä¸ªäº‘ç«‹æ–¹è´¦å·ï¼Œæ³¨å†Œç‚¹[è¿™é‡Œ](http://www.yunlifang.cn?u=anon9zbg)ã€‚

## ä¹°ä¸ªæœåŠ¡å™¨

ç”±äºåªæ˜¯æ‹¨å·åŠä»£ç†ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸éœ€è¦éå¸¸é«˜çš„æ€§èƒ½ï¼Œæˆ‘ä¹°çš„ 0.5G 100M çš„é…ç½®ï¼Œé“¾æ¥[è¿™é‡Œ](https://www.yunlifang.cn/dynamicvpssdzzlt.asp)ã€‚

è´­ä¹°å¦‚ä¸‹å›¾ï¼š

![è´­ä¹°æˆªå›¾](https://ws3.sinaimg.cn/large/006tNc79ly1g2bodt7e9tj30u014kah9.jpg)

## é…ç½®æœåŠ¡å™¨

### 1. æ›´æ–°ç³»ç»Ÿ

```bash
# yum update -y
```

### 2. å®‰è£…å¿…è¦è½¯ä»¶

#### é…ç½® python3.6 æ•°æ®æº

```bash
# yum install epel-release https://centos7.iuscommunity.org/ius-release.rpm -y
```

#### å®‰è£… vim squid httpd-tools python36 pip3

```bash
# yum install vim squid httpd-tools python36 python36u-pip -y
```

### 3. é…ç½® squid

é…ç½®å¼€æœºå¯åŠ¨

```bash
# systemctl enable squid
```

æ·»åŠ  squid ç”¨æˆ·åå¯†ç éªŒè¯

```bash
# touch /etc/squid/squid_passwd
# chown squid:squid /etc/squid/squid_passwd
# htpasswd /etc/squid/squid_passwd ä½ çš„ç”¨æˆ·å
```

ä¿®æ”¹ squid é…ç½®æ–‡ä»¶

```bash
# vi /etc/squid/squid.conf
```

æ·»åŠ å¦‚ä¸‹é…ç½®ï¼Œå¤§æ¦‚åœ¨ 55 è¡Œä¹‹å‰ï¼Œå…·ä½“ä½œç”¨è¯·è‡ªè¡Œ Googleã€‚

> auth_param basic program /usr/lib64/squid/basic_ncsa_auth /etc/squid/squid_passwd
> 
> auth_param basic children 5
> 
> auth_param basic realm Squid proxy-caching web server
> 
> auth_param basic credentialsttl 2 hours
> 
> auth_param basic casesensitive off
> 
> acl ncsa_users proxy_auth REQUIRED
> 
> http_access allow ncsa_users

å¦‚æœéœ€è¦é«˜åŒ¿ä»£ç†ï¼ˆå…¶å®æ˜¯å¿…é¡»çš„ï¼‰ï¼Œå¢åŠ ä»¥ä¸‹é…ç½®åˆ°é…ç½®æ–‡ä»¶ã€‚

> request_header_access Via deny all
> 
> request_header_access X-Forwarded-For deny all
> 
> request_header_access From deny all

**å¦‚éœ€ä¿®æ”¹ç«¯å£è¯·è‡ªè¡Œä¿®æ”¹é…ç½®æ–‡ä»¶**

## é…ç½®è‡ªåŠ¨æ‹¨å·æœåŠ¡

### 1. å®‰è£… python ä¾èµ–

```bash
# pip3.6 install requests-html
```

### 2. åˆ›å»º vps.py æ–‡ä»¶

```bash
# vi ~/vps.py
```

vps.py æ–‡ä»¶æ¨¡æ¿

```python
# -*- coding: utf-8 -*-
import datetime
import os
import traceback

from requests_html import HTMLSession

"""
åŠ¨æ€æ‹¨å· VPS å¾ªç¯æ‹¨å·æ±‡æŠ¥ IP
"""


def re_pppoe():
    """
    é‡æ–°æ‹¨å·å¹¶è¿”å› IP

    :return: æ–°çš„å¤–ç½‘ IP
    :rtype: str
    """
    os.system('/usr/sbin/pppoe-stop')
    os.system('/usr/sbin/pppoe-start')
    result = os.popen('/usr/sbin/pppoe-status')
    ip = ''
    for r in result:
        if r.find('inet') != -1:
            ip = r[r.find('inet') + 5:r.find('peer')].strip()
    return ip


def send_ip(name, ip):
    """
    å‘æœåŠ¡æ±‡æŠ¥ IP

    :param name: æ‹¨å· VPS åç§°
    :type name: str
    :param ip: IP ä¿¡æ¯
    :type ip: str
    :return:
    """
    session = HTMLSession()
    response = None
    try_again = 5
    while try_again > 0:
        try:
            response = session.post(
                url='ä½ çš„æœåŠ¡åœ°å€',
                data={
                    'name': name,
                    'ip': ip
                }
            )
            break
        except Exception:
            try_again -= 1
    if try_again <= 0:
        # ä½ çš„é”™è¯¯å¤„ç†ä»£ç 
        pass
    if response is not None:
        response.close()
    session.close()


def main():
    """
    ä¸»æ–¹æ³•ï¼Œæ±‡æŠ¥ç©º IP ç„¶åé‡æ–°æ‹¨å·å¹¶æ±‡æŠ¥æ–° IPã€‚

    :return:
    """
    code = ''
    for r in os.popen('cat ~/.bashrc'):
        if r.find('PS1') != -1:
            code = r[r.find('g')+1:r.find('g')+3]
    my_name = f'vps{code}'
    send_ip(my_name, '0.0.0.0')
    ip = ''
    while ip == '':
        ip = re_pppoe()
    send_ip(my_name, ip)


if __name__ == '__main__':
    main()

```

### 3. é…ç½®è®¡åˆ’ä»»åŠ¡

æ¯å°æ—¶çš„ç¬¬0åˆ†é’Ÿã€ç¬¬10åˆ†é’Ÿã€ç¬¬20åˆ†é’Ÿã€ç¬¬30åˆ†é’Ÿã€ç¬¬40åˆ†é’Ÿã€ç¬¬50åˆ†é’Ÿé‡æ–°æ‹¨å·å¹¶æ±‡æŠ¥ IP ä¿¡æ¯ã€‚

```bash
# 0,10,20,30,40,50 * * * * python3.6 ~/vps.py > /root/vps.log 2>&1 &
```

## æ‹¨å·ç›¸å…³å‘½ä»¤

* æ‹¨å·

```bash
# pppoe-start
```

* åœæ­¢

```bash
# pppoe-stop
```

* çŠ¶æ€

```bash
# pppoe-stauts
```

## è¿˜æœ‰ç‚¹å‚»å¯ä»¥é…ç½®ï¼Ÿ

ä¸ªäººä¹ æƒ¯äºé…ç½®ä¸€ä¸‹ç”¨æˆ·å˜é‡ã€vié…ç½®ã€ä¸»æœºåï¼Œæ­¤èŠ‚ç‚¹å¯é…å¯ä¸é…ã€‚

* ç”¨æˆ·å˜é‡

```bash
vi ~/.bashrc
```

* vi é…ç½®

```bash
vi /etc/vimrc
```

* ä¸»æœºå

```bash
hostnamectl set-hostname ä½ çš„ä¸»æœºå
```

## è¿˜å·®ç‚¹å•¥ï¼Ÿ

* ä¸€ä¸ªæ¥æ”¶æ‹¨å· VPS å¤–ç½‘ IP çš„æœåŠ¡ç«¯ï¼›
* æœ¬åœ° squid åå‘ä»£ç†é…ç½®ï¼›
* ä¸€ä¸ªä½¿ç”¨æ‹¨å· VPS çˆ¬çˆ¬æ¶æ„çš„ç¤ºä¾‹ç¨‹åºã€‚

ä»¥ä¸Šå‡ é¡¹å¦æ–‡å†è®°å§ã€‚

## æ¬¢è¿è”ç³»

æœ‰é—®é¢˜å¯ä»¥[é‚®ä»¶](mailto:snakejordan@gmail.com)è”ç³»ã€‚

## å¤‡å¿˜ä¸€ä¸‹äº‘ç«‹æ–¹é“¾æ¥

![http://www.yunlifang.cn?u=anon9zbg](http://www.yunlifang.cn/user/img/720X90.png "äº‘ç«‹æ–¹é“¾æ¥")